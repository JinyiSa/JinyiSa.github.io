<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>常见MCU功耗测试</title>
      <link href="/2023/05/15/MCUPowerCosumptionRank/"/>
      <url>/2023/05/15/MCUPowerCosumptionRank/</url>
      
        <content type="html"><![CDATA[<figure><img src="https://s2.loli.net/2023/05/15/ZyzI7oUNfAQ4lu6.jpg" alt="" /><figcaption>STM32F103RBTx.jpg</figcaption></figure><h2 id="一些哔哔">一些哔哔</h2><p>去楼上实验室Van♂的时候学弟跟我提了一嘴STM32U575标称功耗的事，顺便展示了以下他参加众筹的合宙IoT Power，遂临时起意，测了以下手头有的一些常见MCU的功耗，于是有了本文</p><h2 id="测试结果">测试结果</h2><p>首先声明，受时间和测试条件限制，我并不能测到非常精确的功耗数据，以下的数据仅有参考价值：</p><table><colgroup><col style="width: 14%" /><col style="width: 13%" /><col style="width: 61%" /><col style="width: 9%" /></colgroup><thead><tr class="header"><th>MCU型号</th><th>板卡</th><th>备注</th><th>电流消耗</th></tr></thead><tbody><tr class="odd"><td>ESP32-S</td><td>NodeMCU</td><td>满主频 WiFi + BLE + CH340 外部晶振</td><td>59.40mA</td></tr><tr class="even"><td>ESP32-S3</td><td>CORE-ESP32S3-A10</td><td>满主频 WiFi + BLE + CP2102 外部晶振</td><td>114.2mA</td></tr><tr class="odd"><td>ESP8266</td><td>unknown</td><td>满主频 WiFi + CH340 外部晶振</td><td>81.66mA</td></tr><tr class="even"><td>ESP8266</td><td>ESP-01F</td><td>满主频 WiFi 外部晶振</td><td>79.97mA</td></tr><tr class="odd"><td>GW1N-4</td><td>TangNano-4K</td><td>流水灯程序</td><td>57.88mA</td></tr><tr class="even"><td>MSP430G2553</td><td>LaunchPad</td><td>满主频 无外设</td><td>108.4uA</td></tr><tr class="odd"><td>MSP432E401</td><td>LaunchPad</td><td>满主频 ADC满速轮询 XDS110电源已断开</td><td>8.198mA</td></tr><tr class="even"><td>RP2040</td><td>Pico</td><td>满主频 无外设</td><td>22.17mA</td></tr><tr class="odd"><td>STM32F103RBTx</td><td>NUCLEO</td><td>已断开STLink电源,满主频 + ADC 未设置未使用IO为GPIO Analog</td><td>4.056mA</td></tr><tr class="even"><td>STM32F103C8Tx</td><td>BluePill</td><td>满主频 + ADC + 全TIM + 双外部晶振 未设置未使用IO为GPIO Analog</td><td>10.60mA</td></tr><tr class="odd"><td>STM32F407ZGTx</td><td>FK407M2</td><td>满主频 无外设 双外部晶振 未设置未使用IO为GPIO Analog</td><td>69.43mA</td></tr><tr class="even"><td>STM32G474RETx</td><td>NUCLEO</td><td>满主频 无外设</td><td>41.04mA</td></tr><tr class="odd"><td>STM32H723VGTx</td><td>Boring</td><td>满主频 无外设 双外部晶振 未设置未使用IO为GPIO Analog</td><td>39.58mA</td></tr><tr class="even"><td>STM32H723VGTx</td><td>Boring</td><td>满主频 + 1.16寸LCD 双外部晶振 未设置未使用IO为GPIO Analog</td><td>152.66mA</td></tr><tr class="odd"><td>STM32H743ZITx</td><td>NUCLEO</td><td>V1板卡 无外设 未设置未使用IO为GPIO Analog</td><td>83.89mA</td></tr><tr class="even"><td>STM32H753</td><td>OpenMV4 Plus</td><td>OpenMV 板卡功耗 对MCU功耗无参考价值 未开启LED</td><td>210.6mA</td></tr><tr class="odd"><td>STM32H750VBTx</td><td>FK750M1</td><td>满主频 无外设 双外部晶振 未设置未使用IO为GPIO Analog</td><td>193.5mA</td></tr><tr class="even"><td>STM32U575ZITx</td><td>NUCLEO</td><td>满主频 + DAC Normal Node 全速轮询 未设置未使用IO为GPIO Analog</td><td>14.05mA</td></tr><tr class="odd"><td>TMS320F28379D</td><td>LaunchPad</td><td>官方Blink例程(据说外设全部初始化)</td><td>193.9mA</td></tr><tr class="even"><td>XC7A35T</td><td>E-Element</td><td>仅供电3V3，LED + FPGA 晶振 + 流水灯程序</td><td>49.53mA</td></tr><tr class="odd"><td>XC7Z020</td><td>小熊猫</td><td>5V供电 Cortex-A满速 + PL无程序</td><td>123.6mA</td></tr></tbody></table><h2 id="测试照片-多图">测试照片 (多图)</h2><figure><img src="https://s2.loli.net/2023/05/15/4yCwr2mh1iebWVN.jpg" alt="" /><figcaption>ESP32-S.jpg</figcaption></figure><figure><img src="https://s2.loli.net/2023/05/15/Kv7izbsPYIXWex9.jpg" alt="" /><figcaption>MSP432E401Y.jpg</figcaption></figure><figure><img src="https://s2.loli.net/2023/05/15/crNuChPLbYRoVmS.jpg" alt="" /><figcaption>OpenMV4 Plus</figcaption></figure><figure><img src="https://s2.loli.net/2023/05/15/kaMgoF1Uj72dCJ6.jpg" alt="" /><figcaption>STM32F103C8Tx.jpg</figcaption></figure><figure><img src="https://s2.loli.net/2023/05/15/ZyzI7oUNfAQ4lu6.jpg" alt="" /><figcaption>STM32F103RBTx.jpg</figcaption></figure><figure><img src="https://s2.loli.net/2023/05/15/VrANhtSH72soaGM.jpg" alt="" /><figcaption>STM32F407ZGTx.jpg</figcaption></figure><figure><img src="https://s2.loli.net/2023/05/15/gvJ9WE5NLZf3lp2.jpg" alt="" /><figcaption>STM32H723VGTx.jpg</figcaption></figure><figure><img src="https://s2.loli.net/2023/05/15/HMrqlXESQ5Of4Bh.jpg" alt="" /><figcaption>TangNano-4K.jpg</figcaption></figure><figure><img src="https://s2.loli.net/2023/05/15/GyE8tRwQ5pclqKS.jpg" alt="" /><figcaption>XC7A35T.jpg</figcaption></figure><h2 id="写在结尾">写在结尾</h2><p>看起来低功耗的王者还是MSP430G2553（bushi），如果说在能用的情况下的低功耗，ST的STM32U575和TI的MSP432E401似乎不错。可惜前几天老师把MSPM0L1306收回去了，不然测试一下也是好的。C2000系列的功耗一开始吓我一跳，后来学弟告诉我TI的例程把所有外设都初始化了，不管例程用不用....顺便吐槽下TI的嵌入式软件。STM32整体表现还不错，但H750.....一枝独秀了属于是，电表倒转。一个令我惊喜的MCU是ESP32-S，对于一个启用了WiFi的MCU，我对他的预计功耗在100mA以上，没想到只有40mA上下，而且ESP8266和ESP32-S3功耗都显著高于它(或许是我记错里面是啥程序了？)回头再写个空程序测试一下。如果手头拿到新板子的话大概会更新吧(咕咕咕)....</p>]]></content>
      
      
      <categories>
          
          <category> MCU </category>
          
          <category> 瞎折腾 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MCU </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TSL1401驱动开发与状态机思想小议</title>
      <link href="/2023/05/10/StateMachineAndTSL1401/"/>
      <url>/2023/05/10/StateMachineAndTSL1401/</url>
      
        <content type="html"><![CDATA[<h2 id="tsl1401">TSL1401</h2><h3 id="why-tsl1401">Why TSL1401?</h3><p>校赛的时候由于连熬几个大夜，赛前忘了调红外阈值，开局跑飞。遂下定决心，扔掉红外，换一种循迹方案。正好老师买了TSL1401CL，于是便有了本文。</p><h3 id="驱动时序">驱动时序</h3><p>这是从TSL1401的DataSheet上截取的时序图:</p><center><figure><img src="https://s2.loli.net/2023/05/10/ilTJ2aVnItq83OB.png" alt="" /><figcaption>TSL1401TimingGeneral</figcaption></figure><figure><img src="https://s2.loli.net/2023/05/10/qUwOrNz2KZ8QXIv.png" alt="" /><figcaption>TSL1401Timing</figcaption></figure></center><p>可以看到，TSL1401的时序还是相对简单的，连续给129个CLK，在起止周期分别给SI脉冲就可以了。但实际上这里有一点坑， 曝光时间是固定的110个周期，如果要做自动曝光的话，就需要调节时钟频率来控制曝光时间。</p><h3 id="第一版代码">第一版代码</h3><p>由于TSL1401的时序并不复杂，我们可以直接用GPIO模拟时序。代码大概是这样:</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">TSL1401Initialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    AverageBrightness <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>FrameBuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">HAL_SYSTICK_Config</span><span class="token punctuation">(</span><span class="token function">HAL_RCC_GetHCLKFreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">uint16_t</span> <span class="token function">TSL1401ReadOut</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> HalfClockPeriod<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">uint32_t</span> AverageBrightness <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_CLK_GPIO_Port<span class="token punctuation">,</span> TSL_CLK_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_SI_GPIO_Port<span class="token punctuation">,</span> TSL_SI_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_CLK_GPIO_Port<span class="token punctuation">,</span> TSL_CLK_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_SI_GPIO_Port<span class="token punctuation">,</span> TSL_SI_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_CLK_GPIO_Port<span class="token punctuation">,</span> TSL_CLK_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_SI_GPIO_Port<span class="token punctuation">,</span> TSL_SI_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_CLK_GPIO_Port<span class="token punctuation">,</span> TSL_CLK_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">HAL_ADC_PollForConversion</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TSL_ADC_HANDLE<span class="token punctuation">,</span> HAL_MAX_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>        buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">HAL_ADC_GetValue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TSL_ADC_HANDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>        AverageBrightness <span class="token operator">=</span> AverageBrightness <span class="token operator">+</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">HAL_Delay</span><span class="token punctuation">(</span>HalfClockPeriod<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_CLK_GPIO_Port<span class="token punctuation">,</span> TSL_CLK_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    AverageBrightness <span class="token operator">=</span> AverageBrightness <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> AverageBrightness<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">TSL1401AutoExposure</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">uint16_t</span> avg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token class-name">uint16_t</span> frameBuffer<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token class-name">uint16_t</span> halfClockPeriod <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>avg <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token operator">&amp;&amp;</span> halfClockPeriod <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>avg <span class="token operator">></span> <span class="token number">3500</span> <span class="token operator">&amp;&amp;</span> halfClockPeriod <span class="token operator">></span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        avg <span class="token operator">=</span> <span class="token function">TSL1401ReadOut</span><span class="token punctuation">(</span>frameBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>avg <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">)</span>            halfClockPeriod <span class="token operator">=</span> halfClockPeriod <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>avg <span class="token operator">></span> <span class="token number">3500</span><span class="token punctuation">)</span>            halfClockPeriod <span class="token operator">=</span> halfClockPeriod <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>写起来非常的轻松愉快，可谓是一气呵成。但就在我写完的一瞬间，我意识到了一个问题：这个程序是阻塞的。这也就意味着这个程序在执行的时候将把整个程序卡住。这玩意可是要整合上PID + 循迹来调小车的，这要是卡个100mS(最大曝光时间)我的PID不得飞到天上去，还是得重写一版非阻塞的驱动。</p><h3 id="非阻塞版驱动">非阻塞版驱动</h3><h4 id="api设计">API设计</h4><p>考虑到是非阻塞式的API，最简单的实现方式就是采用观察者模式，即当读取完成时通知。而在MCU裸机编程中，最简单的方式就是Callback，于是我们有了第一个API：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">TSL1401ReadCpltCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>那么参数和返回值该如何定义呢？Callback将由驱动调用,返回值在这个驱动中似乎是不必要的。而我们希望驱动能将读取完的FrameBuffer传递给外界，于是就定义成这样：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">TSL1401ReadCpltCallback</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token operator">*</span> frameBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>同时，为了在默认情况下过编译，定义一个weak的实现：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>weak<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">TSL1401ReadCpltCallback</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token operator">*</span> frameBuffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>其实这里还塞了其他的东西，暂且按下不表。<br />由于这里还涉及了ADC读取的问题，既然都非阻塞了，那就全部非阻塞好了，ADC配置成中断模式，当ADC读取完成的时候通知一下驱动就好了，于是我们再设计一个回调服务函数，在ADC读取完成回调中调用：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">__ADCCallbackService_TSL1401</span><span class="token punctuation">(</span>ADC_HandleTypeDef<span class="token operator">*</span> hadc<span class="token punctuation">)</span><span class="token punctuation">;</span>```  剩下的部分其实就比较常规了，无非是功能的启用禁用、曝光时间修改、触发单次曝光和初始化。依然由于是非阻塞的关系，我们需要做一个循环被调用的函数，不妨按OS编程的叫法，叫他Service，于是整体的API就出来了，大概是这样：```c<span class="token keyword">void</span> <span class="token function">TSL1401ReadCpltCallback</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token operator">*</span> frameBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">__ADCCallbackService_TSL1401</span><span class="token punctuation">(</span>ADC_HandleTypeDef<span class="token operator">*</span> hadc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">TSL1401Initialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">TSL1401EnableAutoExposure</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">TSL1401DisableAutoExposure</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">TSL1401EnableContinouosExposure</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">TSL1401DisableContinouosExposure</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">TSL1401SetExposureTime</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> exposureTime_uS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">TSL1401BurstReadAsync</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">TSL1401ServiceFunction</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意我给回调服务函数加了两个下划线作为前缀，这是笔者的代码习惯，通常只希望在内部或某个特定地点调用的函数或是变量，笔者都会加上这个前缀。</p><h4 id="驱动实现">驱动实现</h4><p>笔者习惯于将一个c文件内部的变量pack成结构体(面向对象后遗症属于是)，先把变量定义下：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">uint8_t</span>     NextBurstReadFlag<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token class-name">uint8_t</span>     AutoExposureEnable<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token class-name">uint8_t</span>     AdcDataAvailableFlag<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token class-name">uint8_t</span>     ContinuousExposureEnable<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token class-name">uint8_t</span>     ExposureAndReadOutState<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>    <span class="token class-name">uint16_t</span>    HalfClockPeroid<span class="token punctuation">;</span>    <span class="token class-name">uint8_t</span>     ClockCycleCounter<span class="token punctuation">;</span>    <span class="token class-name">uint32_t</span>    AverageBrightness<span class="token punctuation">;</span>    <span class="token class-name">uint32_t</span>    OperationStartTick<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> __TSL1401DriverVariablesPack <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">uint16_t</span> __TSL1401FrameBuffer<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后把只需要动配置的函数都实现了：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>weak<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">TSL1401ReadCpltCallback</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token operator">*</span> frameBuffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">__ADCCallbackService_TSL1401</span><span class="token punctuation">(</span>ADC_HandleTypeDef <span class="token operator">*</span>hadc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hadc<span class="token operator">-></span>Instance <span class="token operator">=</span> TSL_ADC<span class="token punctuation">.</span>Instance<span class="token punctuation">)</span>        __TSL1401DriverVariablesPack<span class="token punctuation">.</span>AdcDataAvailableFlag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">TSL1401Initialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>NextBurstReadFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>AutoExposureEnable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>AdcDataAvailableFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ContinouosExposureEnable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>HalfClockPeriod <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ClockCycleCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>AverageBrightness <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>OperationStartTick <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">HAL_SYSTICK_Config</span><span class="token punctuation">(</span><span class="token function">HAL_RCC_GetHCLK</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">TSL1401EnableAutoExposure</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>AutoExposureEnable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">TSL1401DisableAutoExposure</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>AutoExposureEnable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">TSL1401EnableContinouosExposure</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ContinouosExposureEnable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">TSL1401DisableContinouosExposure</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ContinouosExposureEnable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">TSL1401SetExposureTime</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> exposureTime_uS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>HalfClockPeriod <span class="token operator">=</span> exposureTime_uS <span class="token operator">/</span> <span class="token number">220</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">TSL1401BurstReadAsync</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>__TSL1401DriverVariablesPack<span class="token punctuation">.</span>ContinouosExposureEnable<span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>NextBurstReadFlag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>值得注意的是笔者将SysTick配置到了1uS来提供时钟源(因为小车上的定时器不够用了)，这将导致HAL_Delay()的延时单位从mS变成uS，如果需要HAL_Delay()的读者需要自己配置一个1uS的tick来提供时钟源。<br />接下来就是重头戏——Service的编写。其实从__TSL1401DriverVariablesPack的定义中就能看出我的意图——状态机。对着时序图切分状态，我们不妨定义一个枚举类型：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">&#123;</span>    SIPulseGenerate_ClkHighSILow_E  <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>    SIPulseGenerate_ClkLowSIHigh_E  <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">,</span>    ReadOut_ClkLowAdcStart_E        <span class="token operator">=</span> <span class="token number">0x2</span><span class="token punctuation">,</span>    ReadOut_ClkLowAdcConvCplt_E     <span class="token operator">=</span> <span class="token number">0x3</span><span class="token punctuation">,</span>    ReadOut_ClkHigh_E               <span class="token operator">=</span> <span class="token number">0x4</span><span class="token punctuation">,</span>    ReadOut_AllDone_E               <span class="token operator">=</span> <span class="token number">0x5</span><span class="token punctuation">,</span>    Idle_E                          <span class="token operator">=</span> <span class="token number">0xF</span><span class="token punctuation">&#125;</span> ExposureAndReadOutState_E<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后把__TSL1401DriverVariablesPack改写成这样：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">uint8_t</span>     NextBurstReadFlag<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token class-name">uint8_t</span>     AutoExposureEnable<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token class-name">uint8_t</span>     AdcDataAvailableFlag<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token class-name">uint8_t</span>     ContinuousExposureEnable<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token class-name">uint8_t</span>     reservedBits<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>    <span class="token class-name">uint16_t</span>    HalfClockPeroid<span class="token punctuation">;</span>    <span class="token class-name">uint8_t</span>     ClockCycleCounter<span class="token punctuation">;</span>    <span class="token class-name">uint32_t</span>    AverageBrightness<span class="token punctuation">;</span>    <span class="token class-name">uint32_t</span>    OperationStartTick<span class="token punctuation">;</span>    ExposureAndReadOutState_E   ExposureAndReadOutState<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> __TSL1401DriverVariablesPack <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同时改写下初始化：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">TSL1401Initialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>NextBurstReadFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>AutoExposureEnable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>AdcDataAvailableFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ContinouosExposureEnable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> SIPulseGenerate_ClkHighSILow_E<span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>HalfClockPeriod <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ClockCycleCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>AverageBrightness <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>OperationStartTick <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">HAL_SYSTICK_Config</span><span class="token punctuation">(</span><span class="token function">HAL_RCC_GetHCLK</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后开始对着时序图画一个状态机：</p><figure><img src="https://s2.loli.net/2023/05/11/7GSWkgHxfDqu3y2.png" alt="" /><figcaption>TSL1401State.png</figcaption></figure><p>接下来对着状态机写出函数即可：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">TSL1401ServiceFunction</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">switch</span><span class="token punctuation">(</span>__TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">case</span> SIPulseGenerate_ClkHighSILow_E<span class="token operator">:</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>__TSL1401DriverVariablesPack<span class="token punctuation">.</span>ClockCycleCounter <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>OperationStartick <span class="token operator">+</span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>HalfClockPeriod<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_CLK_GPIP_Port<span class="token punctuation">,</span> TSL_CLK_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_SI_GPIO_Port<span class="token punctuation">,</span> TSL_SI_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>                    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>OperationStartick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> SIPulseGenerate_ClkLowSIHigh_E<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> ReadOut_ClkLowAdcStart_E<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> SIPulseGenerate_ClkLowSIHigh_E<span class="token operator">:</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>OperationStartick <span class="token operator">+</span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>HalfClockPeriod<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_CLK_GPIP_Port<span class="token punctuation">,</span> TSL_CLK_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_SI_GPIO_Port<span class="token punctuation">,</span> TSL_SI_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>                __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ClockCycleCounter <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>                __TSL1401DriverVariablesPack<span class="token punctuation">.</span>OperationStartick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                __TSL1401DriverVariablesPack <span class="token operator">=</span> SIPulseGenerate_ClkHighSILow_E<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> ReadOut_ClkLowAdcStart_E<span class="token operator">:</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>__TSL1401DriverVariablesPack<span class="token punctuation">.</span>ClockCycleCounter <span class="token operator">&lt;</span> <span class="token number">129</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>OperationStartick <span class="token operator">+</span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>HalfClockPeriod<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_CLK_GPIP_Port<span class="token punctuation">,</span> TSL_CLK_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>                    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>AdcDataAvailableFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>OperationStartTick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">HAL_ADC_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TSL_ADC<span class="token punctuation">)</span><span class="token punctuation">;</span>                    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> ReadOut_ClkLowAdcConvCplt_E<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> ReadOut_AllDone_E<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> ReadOut_ClkLowAdcConvCplt_E<span class="token operator">:</span>            __TSL1401DriverVariablesPack<span class="token punctuation">.</span>AverageBrightness <span class="token operator">+=</span> <span class="token function">HAL_ADC_GetValue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TSL_ADC<span class="token punctuation">)</span><span class="token punctuation">;</span>            __TSL1401FrameBuffer<span class="token punctuation">[</span>__TSL1401DriverVariablesPack<span class="token punctuation">.</span>ClockCycleCounter <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">HAL_ADC_GetValue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TSL_ADC<span class="token punctuation">)</span><span class="token punctuation">;</span>            __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> ReadOut_ClkHigh_E<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> ReadOut_ClkHigh_E<span class="token operator">:</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>OperationStartick <span class="token operator">+</span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>HalfClockPeriod<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TSL_CLK_GPIP_Port<span class="token punctuation">,</span> TSL_CLK_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>                __TSL1401DriverVariablesPack<span class="token punctuation">.</span>OperationStartTick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> ReadOut_ClkLowAdcStart_E<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> ReadOut_AllDone_E<span class="token operator">:</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>__TSL1401DriverVariablesPack<span class="token punctuation">.</span>AutoExposureEnable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>__TSL1401DriverVariablesPack<span class="token punctuation">.</span>AverageBrightness <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token operator">&amp;&amp;</span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>HalfClockPeriod <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>HalfClockPeriod <span class="token operator">+=</span> <span class="token number">50</span><span class="token punctuation">;</span>                    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> SIPulseGenerate_ClkHighSILow_E<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__TSL1401DriverVariablesPack<span class="token punctuation">.</span>AverageBrightness <span class="token operator">></span> <span class="token number">3500</span> <span class="token operator">&amp;&amp;</span> __TSL1401DriverVariablesPack<span class="token punctuation">.</span>HalfClockPeriod <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>HalfClockPeriod <span class="token operator">-=</span> <span class="token number">50</span><span class="token punctuation">;</span>                    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> SIPulseGenerate_ClkHighSILow_E<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    <span class="token function">TSL1401ReadCpltCallback</span><span class="token punctuation">(</span>__TSL1401FrameBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>__TSL1401DriverVariablesPack<span class="token punctuation">.</span>ContinouosExposureEnable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> SIPulseGenerate_ClkHighSILow_E<span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                        __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> Idle_E<span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>__TSL1401DriverVariablesPack<span class="token punctuation">.</span>ContinouosExposureEnable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> SIPulseGenerate_ClkHighSILow_E<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> Idle_E<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> Idle_E<span class="token operator">:</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>__TSL1401DriverVariablesPack<span class="token punctuation">.</span>NextBurstReadFlag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                __TSL1401DriverVariablesPack<span class="token punctuation">.</span>NextBurstReadFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                __TSL1401DriverVariablesPack<span class="token punctuation">.</span>ExposureAndReadOutState <span class="token operator">=</span> SIPulseGenerate_ClkHighSILow_E<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>至此，我们的TSL1401驱动算是编写完毕了，进入接下来的话题——状态机。</p><h2 id="状态机编程">状态机编程</h2><h3 id="什么是状态机">什么是状态机</h3><p>状态机是对于事务运行规则的一种抽象，对于状态机而言，有四大基础概念</p><ul><li>状态：即系统的状态</li><li>事件：执行某个操作所需要的触发条件</li><li>动作：事件发生后执行的操作</li><li>转移：从一个状态切换到另一个状态</li></ul><p>以上面的TSL1401驱动为例，转移图中的判断就是“事件”，而状态转移和Flag、配置变量就是“动作”。<br />事实上，在FPGA中使用状态机编程更多，而这里之所以用了状态机，是因为我们希望整个系统是异步的，而使用了Visitor设计模式。在Visitor设计模式中，操作完成会触发一个“事件”，为了管理这种“事件”触发的“动作”，我们便需要引入状态机。</p><h3 id="why-state-machine">Why State Machine?</h3><p>前文提到，要异步就得状态机，所以为什么选择状态机可以换一个问法，为什么用异步编程？其实说来说去也无非一句话——最大化执行效率。如果使用传统的同步(Synchronous)编程，IO方法事实上是阻塞的，这也就意味着，在等待IO操作完成的过程之中，CPU是空转的，效率非常低下。事实上，在新版本的Cpp标准(C++ 20)里引入了co_await和co_async关键字，可以简单的实现异步操作，然而嵌入式编译器一般跟进标准非常慢....并且在嵌入式里使用C++并不是什么明智的决定(会带来更大的RAM和ROM资源开销且g++等c++编译器的行为并不稳定)，所以在大部分时候我们还是倾向于使用状态机。</p>]]></content>
      
      
      <categories>
          
          <category> MCU </category>
          
          <category> NUEDC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MCU </tag>
            
            <tag> NUEDC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VSCode写一切——MCU篇</title>
      <link href="/2023/04/27/hacking-vscode/"/>
      <url>/2023/04/27/hacking-vscode/</url>
      
        <content type="html"><![CDATA[<h2 id="why-vscode">Why VSCode?</h2><p>首先，Keil、IAR之流虽然不是不能用，但是UI看着有一种复古的美(逃)，并且.....笔者习惯于在Linux下开发，这俩货都不支持Windows之外的任何平台，所以这俩玩意被pass了。其次，笔者早年确实折腾过CubeIDE等一系列基于Eclipse的IDE。确实能跨平台，魔改完CDT的补全触发机制之后功能也算可用。但是，eclipse的内存泄漏问题不可谓不恶名昭彰。笔者那台8G RAM的开发机，如果长时间开着eclipse + Firefox开上十几个tab，RAM就不够了...所以，eclipse系也不行。最终我把目光转向了VSCode，一番折腾之下，搞出了一套笔者自己用着挺顺手的方案。</p><h2 id="依赖安装">依赖安装</h2><h3 id="linux篇">Linux篇</h3><p>以笔者用的Linux Mint为例，首先安装gcc,make这些编译环境 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> gcc-arm-none-eabi libnewlib-arm-none-eabi binutils-arm-none-eabi gdb-multiarch <span class="token function">make</span> cmake<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre> 然后安装Language Server和生成CompileDB的工具 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> ccls bear<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre> 最后安装OpenOCD: <pre class="line-numbers language-none"><code class="language-none">sudo apt-get install openocd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre> <strong>注意： 某些MCU可能并不被主干OpenOCD支持，需要自行编译下游OpenOCD</strong></p><h3 id="windows篇">Windows篇</h3><p>先安装MSYS2，在<a href="www.msys2.org">MSYS2官网</a>下载安装包安装即可。然后打开mingw64环境，更新一下系统包 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pacman <span class="token parameter variable">-Syyu</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre> 再安装make等编译工具</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pacman <span class="token parameter variable">-S</span> <span class="token function">make</span> cmake mingw-w64-x86_64-arm-none-eabi-gcc mingw-w64-x86_64-arm-none-eabi-newlib mingw-w64-x86_64-arm-none-eabi-binutils<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后，安装clangd和Python3</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pacman <span class="token parameter variable">-S</span> mingw-w64-clang-x86_64-clang-tools-extra python<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装pip(可能需要魔法上网) <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://bootstrap.pypa.io/get-pip.pypython get-pip.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre> 安装compiledb: <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 <span class="token function">install</span> compiledb <span class="token parameter variable">-i</span> https://pypi.tuna.tsinghua.edu.cn/simple<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre> ### macOS篇 其实非常类似Linux。。。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> https://bootstrap.pypa.io/get-pip.py <span class="token operator">|</span> python3pip3 <span class="token function">install</span> compiledb <span class="token parameter variable">-i</span> https://pypi.tuna.tsinghua.edu.cn/simplebrew <span class="token function">install</span> <span class="token function">make</span> cmake cclsbrew <span class="token function">install</span> <span class="token parameter variable">--cask</span> gcc-arm-embedded<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>似乎brew里没有OpenOCD，所以....只能自食其力了，先安装brew里有的依赖和编译环境</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> capstone hidapi libusbbrew <span class="token function">install</span> pkg-config libtool autoconf automake<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>手动编译安装libjaylink</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/syntacore/libjaylink.git <span class="token parameter variable">--depth</span><span class="token operator">=</span><span class="token number">1</span><span class="token builtin class-name">cd</span> libjaylink./autogen.sh./configure<span class="token function">make</span> <span class="token parameter variable">-j</span><span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span><span class="token function">make</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编译安装OpenOCD <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone git://git.code.sf.net/p/openocd/code openocd-code<span class="token builtin class-name">cd</span> openocd-code./bootstrap./configure<span class="token function">make</span> <span class="token parameter variable">-j</span> <span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span>mak clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p><strong>不要乱删源码，卸载的时候需要makefile</strong></p><h2 id="vscode插件安装">VSCode插件安装</h2><h3 id="linux-和-mac的插件列表">Linux 和 Mac的插件列表：</h3><table><colgroup><col style="width: 22%" /><col style="width: 32%" /><col style="width: 5%" /><col style="width: 39%" /></colgroup><thead><tr class="header"><th>插件</th><th>功能</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr class="odd"><td>Arm Assembly</td><td>为ARM汇编提供高亮</td><td>可选</td><td>-</td></tr><tr class="even"><td>C/C++</td><td>vcFormat工具人</td><td>可选</td><td>vcFormat配置起来比较方便，而且功能比较强大</td></tr><tr class="odd"><td>ccls</td><td>LSP客户端，为VSCode提供C/Cpp语言支持</td><td>必须</td><td>比MS官方的C/C++插件提供的功能强大，并且速度更快</td></tr><tr class="even"><td>Coretex-Debug</td><td>为MCU提供调试功能</td><td>必须</td><td>其实用C/C++那个cppdbg也能配置出来，只是极其麻烦</td></tr><tr class="odd"><td>Doxygen</td><td>Doxygen支持</td><td>可选</td><td>Doxygen可以说是文档神器了2333</td></tr><tr class="even"><td>Doxygen Documentation Generator</td><td>Doxygen格式注释模板自动生成</td><td>可选</td><td>再也不用手动敲doxygen模板辣</td></tr><tr class="odd"><td>GieLens</td><td>更强大的Git集成</td><td>可选</td><td>不用Git的可以忽略</td></tr><tr class="even"><td>ident-rainbow</td><td>渲染缩进时上色，便于分辨缩进</td><td>可选</td><td>-</td></tr><tr class="odd"><td>Makefile Tools</td><td>提供Makefile语言支持和自动配置C/C++ IntelliSense</td><td>必须</td><td>如果不配置IntelliSense C/C++会给你渲染很多并不存在的Error</td></tr><tr class="even"><td>MemoryView</td><td>提供内存监视功能</td><td>可选</td><td>-</td></tr><tr class="odd"><td>RTOS Views</td><td>为调试RTOS提供了一些诸如task监视的功能</td><td>可选</td><td>-</td></tr><tr class="even"><td>Todo Tree</td><td>高亮注释中的TODO和FIXME，并且生成树状图</td><td>可选</td><td>-</td></tr></tbody></table><h3 id="windows插件列表">Windows插件列表</h3><table><colgroup><col style="width: 22%" /><col style="width: 32%" /><col style="width: 5%" /><col style="width: 39%" /></colgroup><thead><tr class="header"><th>插件</th><th>功能</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr class="odd"><td>Arm Assembly</td><td>为ARM汇编提供高亮</td><td>可选</td><td>-</td></tr><tr class="even"><td>C/C++</td><td>vcFormat工具人</td><td>可选</td><td>vcFormat配置起来比较方便，而且功能比较强大</td></tr><tr class="odd"><td>clangd</td><td>LSP客户端，为VSCode提供C/Cpp语言支持</td><td>必须</td><td>稍稍逊色于ccls，但比MS官方那坨东西强了很多</td></tr><tr class="even"><td>Coretex-Debug</td><td>为MCU提供调试功能</td><td>必须</td><td>其实用C/C++那个cppdbg也能配置出来，只是极其麻烦</td></tr><tr class="odd"><td>Doxygen</td><td>Doxygen支持</td><td>可选</td><td>Doxygen可以说是文档神器了2333</td></tr><tr class="even"><td>Doxygen Documentation Generator</td><td>Doxygen格式注释模板自动生成</td><td>可选</td><td>再也不用手动敲doxygen模板辣</td></tr><tr class="odd"><td>GieLens</td><td>更强大的Git集成</td><td>可选</td><td>不用Git的可以忽略</td></tr><tr class="even"><td>ident-rainbow</td><td>渲染缩进时上色，便于分辨缩进</td><td>可选</td><td>-</td></tr><tr class="odd"><td>Makefile Tools</td><td>提供Makefile语言支持和自动配置C/C++ IntelliSense</td><td>必须</td><td>如果不配置IntelliSense C/C++会给你渲染很多并不存在的Error</td></tr><tr class="even"><td>MemoryView</td><td>提供内存监视功能</td><td>可选</td><td>-</td></tr><tr class="odd"><td>RTOS Views</td><td>为调试RTOS提供了一些诸如task监视的功能</td><td>可选</td><td>-</td></tr><tr class="even"><td>Todo Tree</td><td>高亮注释中的TODO和FIXME，并且生成树状图</td><td>可选</td><td>-</td></tr></tbody></table><h2 id="happy-coding以stm32为例">Happy Coding(以STM32为例)</h2><p>先生成makefile工程，just like this:</p><figure><img src="https://s2.loli.net/2023/04/27/z5Tf2tRWcvFJqdp.png" alt="" /><figcaption>Makefile_Project_Generate.png</figcaption></figure><p>然后cd到工程目录，Linux用户执行：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bear -- <span class="token function">make</span> <span class="token parameter variable">-j</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>macOS/Windows用户执行:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">compiledb <span class="token function">make</span> <span class="token parameter variable">-n</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这一步是为了生成compild_commands.json，无论是clangd还是ccls都需要用它来配置includePath等工程信息。(对于使用cmake的工程直接加上-DCMAKE_EXPORT_COMPILE_COMMANDS=on即可生成，不需要外部工具)。</p><p>然后用VSCode打开工程目录，就可以Happy Coding辣。</p><figure><img src="https://s2.loli.net/2023/04/27/U1Qcgfdb8TY7sEN.png" alt="" /><figcaption>VSCode.png</figcaption></figure><p><strong>注意：Windows用户需在mingw64中启动code，否则环境变量不全会导致奇奇怪怪的问题</strong></p><h3 id="debug配置">Debug配置</h3><p>在工作目录下建立.vscode文件夹，并在.vscode中建立tasks.json和launch.json两个文件。我的tasks.json如下</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"2.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"tasks"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>            <span class="token property">"label"</span><span class="token operator">:</span> <span class="token string">"build"</span><span class="token punctuation">,</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"process"</span><span class="token punctuation">,</span>            <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"make"</span><span class="token punctuation">,</span>            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"-j"</span><span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>tasks.json可以直接抄过去，但接下来的launch.json需要根据实际情况配置，我的一个工程的launch.json如下:</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>            <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cortex-debug"</span><span class="token punctuation">,</span>            <span class="token property">"servertype"</span><span class="token operator">:</span> <span class="token string">"openocd"</span><span class="token punctuation">,</span>            <span class="token property">"preLaunchTask"</span><span class="token operator">:</span> <span class="token string">"build"</span><span class="token punctuation">,</span>            <span class="token property">"runToEntryPoint"</span><span class="token operator">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span>            <span class="token property">"gdbPath"</span><span class="token operator">:</span> <span class="token string">"gdb-multiarch"</span><span class="token punctuation">,</span>            <span class="token property">"cwd"</span><span class="token operator">:</span> <span class="token string">"$&#123;workspaceFolder&#125;"</span><span class="token punctuation">,</span>            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Debug with OpenOCD"</span><span class="token punctuation">,</span>            <span class="token property">"showDevDebugOutput"</span><span class="token operator">:</span> <span class="token string">"both"</span><span class="token punctuation">,</span>            <span class="token property">"objdumpPath"</span><span class="token operator">:</span> <span class="token string">"arm-none-eabi-objdump"</span><span class="token punctuation">,</span>            <span class="token property">"executable"</span><span class="token operator">:</span> <span class="token string">"$&#123;workspaceFolder&#125;/build/$&#123;workspaceFolderBasename&#125;.elf"</span><span class="token punctuation">,</span>            <span class="token property">"svdFile"</span><span class="token operator">:</span> <span class="token string">"/media/jinyi/Jinyi/Software/CubeProgrammer/SVD/STM32F103.svd"</span><span class="token punctuation">,</span>            <span class="token property">"configFiles"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"interface/stlink.cfg"</span><span class="token punctuation">,</span>                <span class="token string">"target/stm32f1x.cfg"</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对于macOS用户，需要把gdbPath改为arm-none-eabi-gdb。如果没有对应芯片的SVD请直接删除svdFile一项。如果是自己使用CubeMX直接生成的文件夹可以不动executable，如果是从网上下载/Clone的代码，请将executable替换为你的elf文件路径。最后,configFiles需要根据自己的调试器和MCU配置，可以在/usr/local/share/openocd/scripts或者/usr/share/openocd/scripts/下找到target和interface文件夹，在里面选择自己使用的配置即可。需要注意的是configFiles中两个配置项的顺序 <strong>不能调换</strong> ，否则会导致无法调试。</p>]]></content>
      
      
      <categories>
          
          <category> MCU </category>
          
          <category> 瞎折腾 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MCU </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>电赛训练笔记——电容测量篇</title>
      <link href="/2023/04/23/Capacitor-Measurment/"/>
      <url>/2023/04/23/Capacitor-Measurment/</url>
      
        <content type="html"><![CDATA[<h2 id="题目要求">题目要求</h2><ol type="1"><li>使用单片机UART或LCD屏显示测量结果</li><li>测量范围10nF~100nF</li><li>测量绝对误差不大于1nF</li></ol><h2 id="参考方案分析">参考方案分析</h2>老师给我们提供了一个参考方案——用555搭建震荡器，通过测555输出频率来求解电容量。虽然笔者并不打算用这个方案，但还是分析一下好了 <del>(不然怎么能体现出我方案的优越性呢)</del>。这个方案的电路大概长这样:<br /><img src="https://s2.loli.net/2023/04/23/YOPqazVRyGXs18i.png" alt="NE555_Osc_Circuit.png" /><center>(电路图来源于网络，侵删)</center><p>讲道理，这玩意简单到我懒得分析原理了，但不分析原理好像又不太能讲明白为啥不用....<br />简单分析一下好了。首先，555的内部结构长这样:</p><figure><img src="https://s2.loli.net/2023/04/23/95dUvxmbYSjeRKn.png" alt="" /><figcaption>NE555_Internal_Circuit.png</figcaption></figure><p>如果把这玩意替换到上面的图里，555无稳态振荡器的原理就很明了了：</p><ul><li>Stage1: 上电初期，RS触发器的输出为0，DISCH和GND间的BJT关断，此时 <span class="math inline">\(V_{cc}\)</span> 通过 <span class="math inline">\(R_{1}\)</span>和<span class="math inline">\(R_{2}\)</span>给C充电</li><li>Stage2: 充电至<span class="math inline">\(U_{C} &gt; \frac{1}{3}V_{cc}\)</span>, 此时，下面的比较器输出低电平，S端被置0，但R端依然为0，RS触发器状态不变</li><li>Stage3: 充电至<span class="math inline">\(U_{C} &gt; \frac{2}{3}V_{cc}\)</span>，此时，上面的比较器输出高电平，R端被置1，而S端在Stage2中就成了0，RS触发器的输出为1，此时DISCH和GND间BJT导通，电容通过<span class="math inline">\(R_{2}\)</span>放电</li><li>Stage4: 放电至<span class="math inline">\(U_{C} &lt; \frac{2}{3}V_{cc}\)</span>，此时，上面的比较器输出低电平，R端被置0，此时S依然为0，RS触发器输出仍然为1</li><li>Stage5: 放电至<span class="math inline">\(U_{C} &lt; \frac{1}{3}V_{cc}\)</span>，此时，下面的比较器输出高电平，S端被置1，此时RS触发器状态变化，输出翻转到0，状态回到Stage1</li></ul><p>根据上面的过程，我们可以很容易的计算NE555的输出频率和占空比。由于稳定下来之后<span class="math inline">\(U_{C}\)</span>一直介于<span class="math inline">\(\frac{1}{3}V_{cc}\)</span>和<span class="math inline">\(\frac{2}{3}V_{cc}\)</span>之间，对于充电过程，有： <span class="math display">\[ t_{charge} = (R_{1} + R_{2})C\ln{\frac{\frac{2}{3}V_{cc} - V_{cc}}{\frac{1}{3}V_{cc} - V_{cc}}} \]</span> <span class="math display">\[ t_{charge} = (R_{1} + R_{2})C\ln{2} \]</span> 同理可得： <span class="math display">\[ t_{discharge} = R_{2}C\ln{2} \]</span> 所以有： <span class="math display">\[ f = \frac{1}{t_{charge} + t_{discharge}} = \frac{1}{(R_{1} + R_{2})C\ln{2} + R_{2}C\ln{2}}\]</span> <span class="math display">\[ DutyCycle = \frac{t_{charge}}{t_{discharge} + t_{charge}} = \frac{(R_{1} + R_{2})C\ln{2}}{(R_{1} + R_{2})C\ln{2} + R_{2}C\ln{2}} = \frac{R_{1} + R_{2}}{R_{1} + 2R_{2}}\]</span></p><p>Seems good! 然而这个电路有其不可避免的问题： - 首先，NE555本身飘的很厉害。 - 其次，这个电路里出现了<span class="math inline">\(\ln{2}\)</span>，这是个无理数。在处理数据时必然存在浮点数精度丢失的问题。</p><p>于是——就引出了我的方案：V-I变换器恒流充电 + STM32模拟看门狗</p><h2 id="我的方案">我的方案</h2><h3 id="硬件设计-v-i变换器">硬件设计 (V-I变换器)</h3><p>先设计好V-I变换器的拓扑，笔者使用双反馈结构的V-I变换器，电路如下:</p><figure><img src="https://s2.loli.net/2023/04/26/fEwkUAyNVTbt369.png" alt="" /><figcaption>V-IConverterWithTrim.png</figcaption></figure><p>事实上，这个电路依然非常简单。<span class="math inline">\(V_{Trim}\)</span>是用来调零的信号，在分析阶段我们可以认为它就是0（不知道什么是调零的<a href="https://wiki.analog.com/university/courses/electronics/text/chapter-3">戳这里</a>）。我们先约定一些记号：</p><table><thead><tr class="header"><th>符号</th><th>含义</th></tr></thead><tbody><tr class="odd"><td><span class="math inline">\(U_{in}\)</span></td><td><span class="math inline">\(V_{input+}\)</span> 节点电压</td></tr><tr class="even"><td><span class="math inline">\(U_{1}A_{-}\)</span></td><td><span class="math inline">\(U_{1}A\)</span> 反相端电压</td></tr><tr class="odd"><td><span class="math inline">\(U_{1}A_{+}\)</span></td><td><span class="math inline">\(U_{1}A\)</span> 同相端电压</td></tr><tr class="even"><td><span class="math inline">\(U_{1}A_{Out}\)</span></td><td><span class="math inline">\(U_{1}A\)</span> 输出电压</td></tr><tr class="odd"><td><span class="math inline">\(U_{1}B_{+}\)</span></td><td><span class="math inline">\(U_{1}B\)</span> 同相端电压</td></tr><tr class="even"><td><span class="math inline">\(U_{out}\)</span></td><td><span class="math inline">\(V_{output}\)</span> 节点电压</td></tr><tr class="odd"><td><span class="math inline">\(I_{out}\)</span></td><td><span class="math inline">\(R_{5}\)</span>和<span class="math inline">\(C_{3}\)</span> 的电流</td></tr></tbody></table><p>对于这个电路，由运放定律可知,在稳态下，必然有：</p><p><span class="math display">\[ \begin{equation}U_{1}A_{+} = U_{1}A_{-} \end{equation} \]</span></p><p>我们分析 <span class="math inline">\(U_{1}A_{-}\)</span>，很容易有(电阻分压)：</p><p><span class="math display">\[ \begin{equation}U_{1}A_{-} = U_{1}A_{Out} \times \frac{R_2}{R_2 + R_4}\end{equation} \]</span></p><p>然后看 <span class="math inline">\(U_{1}A_{+}\)</span>，同理有：</p><p><span class="math display">\[ \begin{equation}U_{1}A_{+} = \left(U_{1}B_{Out} - U_{in}\right) \times \frac{R_1}{R_1 + R_3}\end{equation} \]</span></p><p>由于 <span class="math inline">\(U_{1}B\)</span> 是跟随器，有：</p><p><span class="math display">\[ \begin{equation}U_{1}B_{Out} = U_{Out}\end{equation} \]</span></p><p>代回式(3)，有：</p><p><span class="math display">\[ \begin{equation}U_{1}A_{+} = \left(U_{Out} - U_{in}\right) \times \frac{R_1}{R_1 + R_3}\end{equation} \]</span></p><p>联立式(1)(2)(5)，有：</p><p><span class="math display">\[ \begin{equation}U_{1}A_{Out} \times \frac{R_2}{R_2 + R_4} = \left( U_{Out} - U_{in} \right) \times \frac{R_1}{R_1 + R_3}\end{equation} \]</span></p><p>对于我们的电路而言：</p><p><span class="math display">\[R_1 = R_2 = R_3 = R_4 = 1K\Omega\]</span></p><p>故而，式(6)稍作整理有：</p><p><span class="math display">\[ \begin{equation}U_{1}A_{Out} = U_{out} - U_{in}\end{equation} \]</span></p><p>对于<span class="math inline">\(R_5\)</span>有：</p><p><span class="math display">\[ \begin{equation}I_{out} = \frac{U}{I} = \frac{U_{1}A_{Out} - U_{out}}{R_5}\end{equation} \]</span></p><p>(7)带入(8)，有： <span class="math display">\[I_{Out} = \frac{U_{in}}{R_5}\]</span></p><p>至此，V-I变换器的理论计算算是完成了，接下来就是<span class="math inline">\(R_5\)</span>取值问题。这个电路的<span class="math inline">\(V_{input}\)</span>将连接到STM32F407的DAC上，故而<span class="math inline">\(U_{in} \in \left[ 0, 3.3 \right] V\)</span> 。对于本题，笔者并不满足于题目的要求，笔者希望电路至少能测量1nF~1uF的电容，并且充电时间介于1mS和60mS之间(充电时间限制来自于软件，后文会提到)。很容易得出充电电流应该在 1uA到55uA之间。不妨取3.3V时满幅输出为60mA，则<span class="math inline">\(R_5\)</span>应为<span class="math inline">\(55K\Omega\)</span>，在<span class="math inline">\(E_{24}\)</span> 系列电阻中取最接近的 <span class="math inline">\(56K\Omega\)</span>，满幅输出约为58.93uA，仍然满足要求。在输出为1uA时，DAC输出是560mV不算过小。所以，<span class="math inline">\(R_5\)</span>取<span class="math inline">\(56K\Omega\)</span>是合适的。<br />至此，我们的硬件设计完成了。接下来就是Happy Coding。</p><h3 id="软件设计">软件设计</h3><p>软件部分相对简单，直接给出设计思路好了。开启一个TIM提供1uS的定时中断，并设置一个累加器记录从充电开始到充电结束的时间。ADC开启模拟看门狗，上界设置为4095，这样在ADC输入达到3.3V时将触发模拟看门狗中断，在这个中断里关闭TIM的定时中断，并通过累加器的值计算电容量。</p>]]></content>
      
      
      <categories>
          
          <category> NUEDC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> EE </tag>
            
            <tag> 模电 </tag>
            
            <tag> MCU </tag>
            
            <tag> NUEDC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>STM32U5踩坑——模拟外设篇</title>
      <link href="/2023/04/18/STM32-U5-Getting-Start/"/>
      <url>/2023/04/18/STM32-U5-Getting-Start/</url>
      
        <content type="html"><![CDATA[<h2 id="初识stm32u5">初识STM32U5</h2><h3 id="关于stm32u5">关于STM32U5</h3><p>STM32U5系列是ST新推出的Cortex-M33架构的MCU产品线，主打超低功耗。由于架构的优化，Cortex-M33事实上也是一种高性能的架构。听起来好像很不错的样子，但是, there are no silver bullet。兼顾超低功耗和高性能必然带来一个结果——编程繁琐且容易出错。</p><h3 id="stm32u5的电源域与时钟树">STM32U5的电源域与时钟树</h3><h4 id="电源域">电源域</h4><p>对于一个现代的MCU而言，<a href="https://en.wikipedia.org/wiki/Power_domains">电源域</a>的分割是必要的。一方面是某些模块对于供电有特殊要求，例如ADC、DAC和比较器这种模拟外设需要尽可能"纯净"的电源，把它们和数字部分的电源划分在一起显然是不合适的。另一方面是不同模块之间的电压不尽相同，例如在STM32U5中，<span class="math inline">\(V_{IOBank}\)</span>需要3V3，而<span class="math inline">\(V_{Core}\)</span>却只能接受1V8。U5的电源大致有这么几个域:</p><ul><li>Core Domain</li><li><span class="math inline">\(V_{DD}\)</span> Domain</li><li>Backup Domain (<span class="math inline">\(V_{BAT}\)</span>)</li><li>Analog Domain (<span class="math inline">\(V_{DDA}\)</span>)</li><li>SMPS Power Stage (这个电源域只有内置DC-DC的型号有)</li><li><span class="math inline">\(V_{DDIO2}\)</span> Domain</li><li><span class="math inline">\(V_{DDUSB}\)</span> Domain</li></ul><p>看名称应该也能猜出来各个电源域负责什么东西，我们踩的一个大坑就和Power Domain有关，暂且按下不表。</p><h4 id="时钟树">时钟树</h4><p>在一个规模稍大的数字系统中，一个时钟往往是不够用的。而我们不希望各个时钟都需要一个独立的震荡器，因为这显然过于消耗IO了。于是，我们在片内做上一系列的PLL，通过它们把输入的主时钟通过分频和倍频调整到合适的频率送给各个模块。我们将片内的PLL和MUX结构称为时钟树。这是从STM32U575<a href="https://www.semiee.com/file/ST/ST-STM32U575QI.pdf">手册</a>中截取的时钟树示意图:<br /><img src="https://s2.loli.net/2023/04/18/tJjUHSofqunCbOY.png" alt="STM32U5ClockTree.png" /><br />可以看到，U5的时钟树比较复杂。我们本次踩坑涉及的部分主要是DAC的时钟问题，这个留到下文再说。</p><h3 id="点个灯吧">点个灯吧</h3><p>讲了这么多，怎么能少了电子界的Hello World——Blink呢？由于笔者使用的NUCLEO-U575ZI-Q，CubeMX自带了BSP，笔者就直接从Board Selector中生成工程了。 其实直接使用默认配置即可，但笔者很不喜欢不开ICache的时候生成代码弹出的那个Warning，遂启用ICache:<br /><img src="https://s2.loli.net/2023/04/18/HlnJYDUKMVOeuWp.png" alt="NUCLEO-U575-ZI-QBlinkCubeMX.png" /> (反正ICache也没有啥需要配置的东西还能增强性能，何乐而不为呢)<br />然后生成代码，打开工程，在初始化代码里加上:</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_RED_GPIO_Port<span class="token punctuation">,</span> LED_RED_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_GREEN_GPIO_Port<span class="token punctuation">,</span> LED_GREEN_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_BLUE_GPIO_Port<span class="token punctuation">,</span> LED_BLUE_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>然后在循环里加上:</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">switch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>        i<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_RED_GPIO_Port<span class="token punctuation">,</span> LED_RED_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_GREEN_GPIO_Port<span class="token punctuation">,</span> LED_GREEN_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_BLUE_GPIO_Port<span class="token punctuation">,</span> LED_BLUE_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>        i<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_RED_GPIO_Port<span class="token punctuation">,</span> LED_RED_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_GREEN_GPIO_Port<span class="token punctuation">,</span> LED_GREEN_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_BLUE_GPIO_Port<span class="token punctuation">,</span> LED_BLUE_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>        i<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_RED_GPIO_Port<span class="token punctuation">,</span> LED_RED_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_GREEN_GPIO_Port<span class="token punctuation">,</span> LED_GREEN_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_BLUE_GPIO_Port<span class="token punctuation">,</span> LED_BLUE_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>        i<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_RED_GPIO_Port<span class="token punctuation">,</span> LED_RED_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_GREEN_GPIO_Port<span class="token punctuation">,</span> LED_GREEN_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_BLUE_GPIO_Port<span class="token punctuation">,</span> LED_BLUE_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>        i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_RED_GPIO_Port<span class="token punctuation">,</span> LED_RED_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_GREEN_GPIO_Port<span class="token punctuation">,</span> LED_GREEN_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_BLUE_GPIO_Port<span class="token punctuation">,</span> LED_BLUE_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>        <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后直接编译下载即可。</p><h2 id="玩玩模拟外设">玩玩模拟外设</h2><p>STM32U575的模拟外设还是挺强悍的ADC1 14Bit 2.5Msps，ADC2 12Bit 2.5Msps。DAC两个通道12Bit，带可开启的SHA。但是有个学弟说U5的ADC有问题，怎么采都是0，笔者遂决定调一下ADC，用默认生成的代码，加上轮询，果然是0，于是就有了本文23333。</p><h3 id="adc调试">ADC调试</h3><p>我先是按其他系列的配置方式把ADC配置为轮询单次采样，CubeMX生成的代码大概是这样：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">MX_ADC1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">/* USER CODE BEGIN ADC1_Init 0 */</span><span class="token comment">/* USER CODE END ADC1_Init 0 */</span><span class="token comment">/* USER CODE BEGIN ADC1_Init 1 */</span><span class="token comment">/* USER CODE END ADC1_Init 1 */</span><span class="token comment">/** Common config*/</span> hadc1<span class="token punctuation">.</span>Instance <span class="token operator">=</span> ADC1<span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ClockPrescaler <span class="token operator">=</span> ADC_CLOCK_ASYNC_DIV1<span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Resolution <span class="token operator">=</span> ADC_RESOLUTION_14B<span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>GainCompensation <span class="token operator">=</span>   <span class="token number">0</span><span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ScanConvMode <span class="token operator">=</span> ADC_SCAN_DISABLE<span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>EOCSelection <span class="token operator">=</span> ADC_EOC_SINGLE_CONV<span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>LowPowerAutoWait <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ContinuousConvMode <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>NbrOfConversion <span class="token operator">=</span>   <span class="token number">1</span><span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>DiscontinuousConvMode <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>DMAContinuousRequests <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>TriggerFrequencyMode <span class="token operator">=</span> ADC_TRIGGER_FREQ_HIGH<span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Overrun <span class="token operator">=</span> ADC_OVR_DATA_PRESERVED<span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>LeftBitShift <span class="token operator">=</span> ADC_LEFTBITSHIFT_NONE<span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ConversionDataManagement <span class="token operator">=</span> ADC_CONVERSIONDATA_DR<span class="token punctuation">;</span> hadc1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>OversamplingMode <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> <span class="token keyword">if</span>   <span class="token punctuation">(</span><span class="token function">HAL_ADC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc1<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token comment">/* USER CODE BEGIN ADC1_Init 2 */</span><span class="token comment">/* USER CODE END ADC1_Init 2 */</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看上去很合理对吧，我们在主程序里添加轮询代码：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">HAL_ADC_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> adcValue<span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> retValue<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    retValue <span class="token operator">=</span> <span class="token function">HAL_ADC_PollForConversion</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc1<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    adcValue <span class="token operator">=</span> <span class="token function">HAL_ADC_GetValue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里随手定义的retValue在后面的调试给我帮了大忙，后面会提到。不如直接开始编译调试吧，然后我就得到了这样的结果:</p><p><img src="https://s2.loli.net/2023/04/18/1fJIWxKoM6iHOrk.png" alt="Debug_ScreenShot.png" /><br />retValue是3，adcValue是0。retValue不是HAL_OK (也就是0)，这中间肯定出了问题，先找找3是什么意思吧。在一番查找之后，可以在stm32u5xx_hal_def.h中找到：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">&#123;</span>    HAL_OK <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">,</span>    HAL_ERROR <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">,</span>    HAL_BUSY <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">,</span>    HAL_TIMEOUT <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">&#125;</span> HAL_StatusTypeDef<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>retValue是3，这意味着Time Out。但是50mS的时间怎么都该足够让一个2.5Msps的ADC完成一次采样了，百思不得其解。遂找一调过U5的学弟询问此事，学弟答：需要在初始化里加入如下代码：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">SET_BIT</span><span class="token punctuation">(</span>RCC<span class="token operator">-></span>AHB3ENR<span class="token punctuation">,</span> RCC_AHB3ENR_PWREN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">SET_BIT</span><span class="token punctuation">(</span>PWR<span class="token operator">-></span>SVMCR<span class="token punctuation">,</span> PWR_SVMCR_AVM1EN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">READ_BIT</span><span class="token punctuation">(</span>PWR<span class="token operator">-></span>SVMSR<span class="token punctuation">,</span> PWR_SVMSR_VDDA1RDY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">SET_BIT</span><span class="token punctuation">(</span>PWR<span class="token operator">-></span>SVMCR<span class="token punctuation">,</span> PWR_SVMCR_ASV<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">CLEAR_BIT</span><span class="token punctuation">(</span>RCC<span class="token operator">-></span>AHB3ENR<span class="token punctuation">,</span> RCC_AHB3ENR_PWREN<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>怎么是手动操作寄存器，赣！遂在工程中一个一个搜索Mask，功夫不负有心人。我在stm32u5xx_hal_pwr_ex.c中找到了这样一个函数：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*** @brief Enable VDDA supply.* @note Remove VDDA electrical and logical isolation, once VDDA supply is* present for consumption saving.* @retval None.*/</span><span class="token keyword">void</span> <span class="token function">HAL_PWREx_EnableVddA</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">SET_BIT</span><span class="token punctuation">(</span>PWR<span class="token operator">-></span>SVMCR<span class="token punctuation">,</span> PWR_SVMCR_ASV<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>似乎是启用<span class="math inline">\(V_{DDA}\)</span>电源域的函数。笔者的开发环境有调用计数功能，我一看函数上面赫然显示"0 ref"，好家伙，合着您压根没开<span class="math inline">\(V_{DDA}\)</span>电源域是吗。遂在MX_ADC1_Init中加上启用电源域的代码：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">HAL_PWREx_EnableVddA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后重新编译调试，果然ADC能够正常采样了。所以....我又跑回去仔细检查了CubeMX配置页面，发现根门没有电源域配置这一项。所以.....即使U5已经上市这么久了，CubeMX的支持还是个半成品......ST你坏事做尽！</p><h3 id="dac调试">DAC调试</h3><p>虽然学弟提的ADC问题解决了，但那个调过U5的学弟又说了另外一个问题，它的DAC似乎不太对，只能运行在很低的采样率下。我想着反正已经开始调了，不如一鼓作气把DAC也调一下。我没有急着开始Coding，鉴于学弟说速度很低，我首先想到的是时钟树配置问题，我在时钟树里找到了这个： <img src="https://s2.loli.net/2023/04/18/ev8QUjgcupkVOmG.png" alt="DAC_Sample_Hold_Clock_MUX.png" /><br />我打出一个？，怎么会接在LSI或者LSE上的，难道DAC只能低频工作吗？我总觉得不太对劲，遂打开了U5的Reference Manual找到DAC部分的DAC Features表格：<br /><img src="https://s2.loli.net/2023/04/18/7Z9gSKjDL2oqiT4.png" alt="U5_DAC_Features.png" /> Maximum sampling rate（吐槽一下，ST怎么把采样率写成采样时间了）1Msps，我现在一头雾水，32.768KHz的Clk怎么能有1Msps的采样率，遂继续读RM，我先是看到了在DAC conversion里这样一段话:<br />HFSEL bits of DAC_MCR must be set when dac_hclk or dac_ker_ck clock speed is faster than 80 MHz. It adds an extra delay to the transfer from DAC_DHRx register to DAC_DORx register. Refer to Table HFSEL description below for the limitation of the DAC_DORx update rate depending on HFSEL bits and dac_hclk clock frequency.If the data is updated or a software/hardware trigger event occurs during the non-allowed.period, the peripheral behavior is unpredictable.The above timing is only related to the limitation of the DAC interface. Refer also to the tSETTLING parameter value in the product datasheet.<br />似乎这个参数我也没配置正确来着，但这不是主要问题，我仍不知道1Msps的采样率从何而来，遂继续看，终于在DAC channel modes一节中找到了问题的答案。U5的DAC分为Normal mode和Sample and hold mode。我找到的那个MUX只负责SHA。。。。破案了。 于是回到CubeMX，配置好DAC High Frequency Mode和Mode Select，生成代码，写一个打锯齿波的程序:</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token function">HAL_DAC_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdac1<span class="token punctuation">,</span> DAC_CHANNEL_1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">HAL_DAC_SetValue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdac1<span class="token punctuation">,</span> DAC_CHANNEL_1<span class="token punctuation">,</span> DAC_ALIGN_12B_R<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    i <span class="token operator">=</span> i <span class="token operator">&lt;</span> <span class="token number">4096</span> <span class="token operator">?</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编译下载，然后挂上示波器，得到了一个大约2KHz的锯齿波。一个周期4096个采样点，换算出来实际采样率居然达到了惊人的4Msps。看来ST的手册还是过于保守了，强行轮询都能做到4Msps，手册上居然只标注为1Msps.....</p>]]></content>
      
      
      <categories>
          
          <category> MCU </category>
          
          <category> 瞎折腾 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MCU </tag>
            
            <tag> 踩坑 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HelloWorld</title>
      <link href="/2023/04/15/HelloWorld/"/>
      <url>/2023/04/15/HelloWorld/</url>
      
        <content type="html"><![CDATA[<h1 id="hello-world">Hello World!</h1>]]></content>
      
      
      <categories>
          
          <category> Boring thins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hello World </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
